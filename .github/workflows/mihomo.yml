name: Generate mihomo rulesets from sources

on:
  schedule:
    - cron: "5 0 * * *"
  workflow_dispatch:

concurrency:
  group: mihomo-from-sources
  cancel-in-progress: true

permissions:
  contents: write

env:
  COMMIT_USER_NAME: ${{ github.actor }}
  COMMIT_USER_EMAIL: ${{ github.actor }}@users.noreply.github.com
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Switch to branch mihomo-rulesets (create if missing)
        run: |
          set -Eeuo pipefail
          if git ls-remote --exit-code --heads origin refs/heads/mihomo-rulesets >/dev/null 2>&1; then
            git fetch --no-tags --depth=1 origin refs/heads/mihomo-rulesets:refs/remotes/origin/mihomo-rulesets
            git switch -c mihomo-rulesets --track origin/mihomo-rulesets || git switch mihomo-rulesets
            git pull --ff-only
          else
            git switch -c mihomo-rulesets
            rm -rf .github || true
            git add -A
            git -c user.email="${COMMIT_USER_EMAIL}" -c user.name="${COMMIT_USER_NAME}" commit -m "Initialize branch without CI"
            git push -u origin HEAD:mihomo-rulesets
          fi

      - name: Prepare helpers from main
        run: |
          set -Eeuo pipefail
          mkdir -p .ci work/geosite work/geoip mihomo-ruleset
          git fetch --no-tags --depth=1 origin main
          git show origin/main:.ci/optimize.py > .ci/optimize.py
          cat > .ci/helpers.sh <<'SH'
          set -Eeuo pipefail
          OPT_PY="${GITHUB_WORKSPACE}/.ci/optimize.py"
          dom_xray_to_mihomo() { python3 "$OPT_PY" domains "$1" "$2" --input-type xray --target to-mihomo --view mihomo; }
          SH

      - name: Resolve latest Mihomo release
        id: resolve
        run: |
          set -Eeuo pipefail
          resp=$(curl -fsSL -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest")
          tag=$(jq -r '.tag_name' <<<"$resp")
          url=$(jq -r '.assets[] | select(.name | test("^mihomo-linux-amd64.*\\.deb$")) | .browser_download_url' <<<"$resp" | head -n1)
          echo "MIHOMO_TAG=$tag" >> "$GITHUB_ENV"
          echo "MIHOMO_DEB_URL=$url" >> "$GITHUB_ENV"

      - name: Install Mihomo
        run: |
          set -Eeuo pipefail
          if [[ -z "${MIHOMO_DEB_URL:-}" || "${MIHOMO_DEB_URL}" == "null" ]]; then
            resp=$(curl -fsSL -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/${MIHOMO_TAG}")
            MIHOMO_DEB_URL=$(jq -r '.assets[] | select(.name | test("^mihomo-linux-amd64.*\\.deb$")) | .browser_download_url' <<<"$resp" | head -n1)
          fi
          curl -fsSL -H "Authorization: token ${GITHUB_TOKEN}" -o /tmp/mihomo.deb "$MIHOMO_DEB_URL"
          sudo apt-get update
          sudo apt-get install -y --fix-missing /tmp/mihomo.deb
          rm -f /tmp/mihomo.deb

      - name: Fetch file lists from sources branch (root geosite/geoip)
        id: lists
        run: |
          set -Eeuo pipefail
          git fetch --no-tags --depth=1 origin sources
          GEOSITE=$(git ls-tree -r --name-only origin/sources:geosite | sed 's|^geosite/||' | tr '\n' ' ')
          GEOIP=$(git ls-tree -r --name-only origin/sources:geoip   | sed 's|^geoip/||'   | tr '\n' ' ')
          echo "GEOSITE=$GEOSITE" >> "$GITHUB_OUTPUT"
          echo "GEOIP=$GEOIP" >> "$GITHUB_OUTPUT"

      - name: Clean output folder
        run: |
          set -Eeuo pipefail
          rm -rf mihomo-ruleset
          mkdir -p mihomo-ruleset

      - name: Build MRS from geosite (XRAY → MIHOMO → .mrs)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          for f in ${{ steps.lists.outputs.GEOSITE }}; do
            [[ -z "$f" ]] && continue
            git show "origin/sources:geosite/$f" > "work/geisite_$f.xray"
            dom_xray_to_mihomo "work/geisite_$f.xray" "work/geisite_$f.mihomo"
            base="${f%.list}"
            mihomo convert-ruleset domain text "work/geisite_$f.mihomo.list" "mihomo-ruleset/geosite-$base.mrs"
          done

      - name: Build MRS from geoip (CIDR → .mrs)
        run: |
          set -Eeuo pipefail
          for f in ${{ steps.lists.outputs.GEOIP }}; do
            [[ -z "$f" ]] && continue
            git show "origin/sources:geoip/$f" > "work/geoip_$f"
            base="${f%.list}"
            mihomo convert-ruleset ipcidr text "work/geoip_$f" "mihomo-ruleset/geoip-$base.mrs"
          done

      - name: Stamp date
        run: echo "DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      - name: Commit MRS
        run: |
          set -Eeuo pipefail
          git config --local user.email "${COMMIT_USER_EMAIL}"
          git config --local user.name  "${COMMIT_USER_NAME}"
          git add -A mihomo-ruleset
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Generate mihomo rulesets ${DATE} (mihomo ${MIHOMO_TAG})"
          git push || true
