name: Generate sources (flattened xray + cidr)

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

concurrency:
  group: sources-builder-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  GOFLAGS: -buildvcs=false
  COMMIT_USER_NAME: github-actions[bot]
  COMMIT_USER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo (default branch)
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Switch to branch sources (create if missing)
        run: |
          set -Eeuo pipefail
          BR="sources"

          git config --local user.name  "${COMMIT_USER_NAME}"
          git config --local user.email "${COMMIT_USER_EMAIL}"

          if git fetch --no-tags --depth=1 origin "refs/heads/${BR}:refs/remotes/origin/${BR}" >/dev/null 2>&1; then
            git switch -C "${BR}" "refs/remotes/origin/${BR}"
            git pull --ff-only || true
          else
            git switch --orphan "${BR}"
            git rm -r --ignore-unmatch . >/dev/null 2>&1 || true
            git commit --allow-empty -m "Initialize sources"
            git push -u origin "HEAD:${BR}"
          fi

      - name: Checkout main helpers (sparse)
        uses: actions/checkout@v6
        with:
          ref: main
          path: main-src
          fetch-depth: 1
          sparse-checkout: |
            .ci
            sections_in
            config_get.json
          sparse-checkout-cone-mode: true

      - name: Prepare helpers and inputs from main
        run: |
          set -Eeuo pipefail

          rm -rf .ci
          mkdir -p .ci _inputs

          if [[ -d main-src/.ci ]]; then
            cp -a main-src/.ci/. .ci/
          fi

          chmod +x .ci/ipset_ops.py .ci/domainset_ops.py 2>/dev/null || true

          if [[ -f main-src/sections_in ]]; then
            cp -f main-src/sections_in sections_in
          else
            rm -f sections_in
          fi

          if [[ -f main-src/config_get.json ]]; then
            cp -f main-src/config_get.json config_get.json
          else
            rm -f config_get.json
          fi

          rm -rf main-src

          cat > .ci/helpers.sh <<'SH'
          set -Eeuo pipefail

          OPT_PY="${GITHUB_WORKSPACE}/.ci/optimize.py"

          dom_xray_preserve() { python3 "$OPT_PY" domains "$1" "$2" --input-type xray  --target preserve; }
          dom_from_clean_to_xray_suffix() { python3 "$OPT_PY" domains "$1" "$2" --input-type clean --target suffix; }
          dom_from_clean_to_xray_exact()  { python3 "$OPT_PY" domains "$1" "$2" --input-type clean --target exact; }

          ip_opt() { python3 "$OPT_PY" ips "$1" "$2"; }

          get() {
            curl -fsSL --compressed \
              --connect-timeout 10 --max-time 120 \
              --retry 5 --retry-delay 2 --retry-connrefused --retry-all-errors \
              "$1" -o "$2"
          }
          SH

      - name: Checkout v2fly/domain-list-community (data only)
        uses: actions/checkout@v6
        with:
          repository: v2fly/domain-list-community
          path: community
          fetch-depth: 1
          sparse-checkout: |
            data
          sparse-checkout-cone-mode: true
          filter: blob:none

      - name: Clean output folders in workspace (root geosite/geoip)
        run: |
          set -Eeuo pipefail
          rm -rf geosite geoip
          mkdir -p geosite geoip

      - name: Resolve keep-set from sections_in (deterministic) and flatten → geosite/
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh

          DATA_DIR="community/data"
          INTEREST_FILE="sections_in"

          declare -A keep=()
          queue=()

          add_item() {
            local x="$1"
            [[ -n "$x" ]] || return 0
            if [[ -z "${keep[$x]:-}" ]]; then
              keep["$x"]=1
              queue+=("$x")
            fi
          }

          if [[ -f "$INTEREST_FILE" ]]; then
            while IFS= read -r line; do
              line="${line//$'\r'/}"
              line="${line%%#*}"
              line="$(echo "$line" | xargs)"
              [[ -n "$line" ]] || continue
              add_item "$line"
            done < "$INTEREST_FILE"
          fi

          add_item "category-ru"
          add_item "category-gov-ru"
          add_item "private"

          while ((${#queue[@]})); do
            cur="${queue[0]}"
            queue=("${queue[@]:1}")

            p="${DATA_DIR}/${cur}"
            [[ -f "$p" ]] || continue

            incs="$(
              sed -E 's/\r$//' "$p" \
              | grep '^include:' || true
            )"

            if [[ -n "$incs" ]]; then
              while IFS= read -r inc; do
                inc="${inc#include:}"
                inc="${inc%%#*}"
                inc="$(echo "$inc" | xargs)"
                [[ -n "$inc" ]] || continue
                add_item "$inc"
              done < <(printf '%s\n' "$incs" | LC_ALL=C sort -u)
            fi
          done

          for rel in $(printf '%s\n' "${!keep[@]}" | LC_ALL=C sort); do
            src="${DATA_DIR}/${rel}"
            [[ -f "$src" ]] || continue
            out="geosite/${rel}"
            mkdir -p "$(dirname "$out")"
            dom_xray_preserve "$src" "$out"
          done

      - name: Download external one-file DOMAIN sources (.src)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          get "https://raw.githubusercontent.com/1andrevich/Re-filter-lists/main/community.lst" _inputs/refilter-community-domains.src
          get "https://raw.githubusercontent.com/1andrevich/Re-filter-lists/main/domains_all.lst" _inputs/refilter-domains.src
          get "https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/inside-raw.lst" _inputs/russia-inside.src
          get "https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/outside-raw.lst" _inputs/russia-outside.src
          get "https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Services/google_ai.lst" _inputs/google-ai.src

      - name: Normalize external DOMAIN sources → XRAY lists in geosite/
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          dom_from_clean_to_xray_suffix _inputs/refilter-community-domains.src geosite/refilter-community
          dom_from_clean_to_xray_suffix _inputs/refilter-domains.src            geosite/refilter
          dom_from_clean_to_xray_suffix _inputs/russia-inside.src               geosite/russia-inside
          dom_from_clean_to_xray_suffix _inputs/russia-outside.src              geosite/russia-outside
          dom_from_clean_to_xray_suffix _inputs/google-ai.src                   geosite/google-ai

      - name: Build derived geosite lists (ban-ru)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh

          tmp="$(mktemp)"
          python3 .ci/domainset_ops.py \
            --mode intersect \
            --set geosite/refilter,geosite/refilter-community,geosite/russia-inside,geosite/google-ai,geosite/youtube \
            --set geosite/category-ru \
            --out "$tmp"

          { cat "$tmp"; printf '%s\n' jut.su habr.com 4pda.to; } > "${tmp}.add"
          dom_xray_preserve "${tmp}.add" geosite/category-ban-ru
          rm -f "$tmp" "${tmp}.add" "${tmp}.add.list"

      - name: Build geosite/router (dedup + optimize, preserve)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          tmp="$(mktemp)"

          {
            for f in geosite/russia-inside geosite/google-ai geosite/refilter-community; do
              [[ -f "$f" || -f "$f.list" ]] || continue
              cat "$f" 2>/dev/null || true
              cat "$f.list" 2>/dev/null || true
              echo
            done
          } > "$tmp"

          dom_xray_preserve "$tmp" geosite/router
          rm -f "$tmp" "$tmp.list"

      - name: Build geosite/ru-bundle (dedup + optimize, preserve)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          tmp="$(mktemp)"

          {
            for f in geosite/russia-inside geosite/google-ai geosite/refilter geosite/refilter-community; do
              [[ -f "$f" || -f "$f.list" ]] || continue
              cat "$f" 2>/dev/null || true
              cat "$f.list" 2>/dev/null || true
              echo
            done
          } > "$tmp"

          dom_xray_preserve "$tmp" geosite/ru-bundle
          rm -f "$tmp" "$tmp.list"

      - name: Build geosite/block-out (dedup + optimize, preserve)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          tmp="$(mktemp)"

          {
            for f in geosite/private geosite/category-gov-ru geosite/russia-outside; do
              [[ -f "$f" || -f "$f.list" ]] || continue
              cat "$f" 2>/dev/null || true
              cat "$f.list" 2>/dev/null || true
              echo
            done
          } > "$tmp"

          dom_xray_preserve "$tmp" geosite/block-out
          rm -f "$tmp" "$tmp.list"

      - name: Download upstream geoip.dat & build base RU/PRIVATE (optional)
        run: |
          set -Eeuo pipefail
          if [[ -s config_get.json ]]; then
            rm -rf geoip-src extracted
            git clone --depth=1 https://github.com/Loyalsoldier/geoip geoip-src
            pushd geoip-src >/dev/null
            go build ./
            popd >/dev/null
            ./geoip-src/geoip convert -c ./config_get.json
            python3 .ci/optimize.py ips extracted/ru.txt      geoip/ru
            python3 .ci/optimize.py ips extracted/private.txt geoip/private
            rm -rf extracted geoip-src
          fi

      - name: Download external one-file IP sources (.src)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          get "https://raw.githubusercontent.com/GhostRooter0953/discord-voice-ips/master/voice_domains/discord-voice-ip-list" _inputs/discord-voice-ips.src
          get "https://core.telegram.org/resources/cidr.txt" _inputs/telegram-ips.src
          get "https://www.cloudflare.com/ips-v4" _inputs/cloudflare4.src
          get "https://raw.githubusercontent.com/1andrevich/Re-filter-lists/main/ipsum.lst" _inputs/refilter-ips.src
          get "https://raw.githubusercontent.com/1andrevich/Re-filter-lists/main/community_ips.lst" _inputs/refilter-community-ips.src

          cat _inputs/discord-voice-ips.src > _inputs/ru-bundle.src

      - name: Normalize IP sources → CIDR lists in geoip/
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          ip_opt _inputs/discord-voice-ips.src      geoip/discord-voice
          ip_opt _inputs/telegram-ips.src           geoip/telegram
          ip_opt _inputs/cloudflare4.src            geoip/cloudflare4
          ip_opt _inputs/refilter-ips.src           geoip/refilter
          ip_opt _inputs/refilter-community-ips.src geoip/refilter-community
          ip_opt _inputs/ru-bundle.src              geoip/ru-bundle

      - name: Build derived geoip lists via ipset_ops.py
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh

          python3 .ci/ipset_ops.py \
            --mode intersect \
            --set geoip/refilter,geoip/refilter-community,geoip/discord-voice \
            --set geoip/ru \
            --out geoip/category-ban-ru.list

          python3 .ci/ipset_ops.py \
            --mode diff \
            --A geoip/refilter,geoip/refilter-community,geoip/discord-voice \
            --B geoip/ru \
            --out geoip/ban-no-ru.list

          { cat geoip/ban-no-ru.list; echo; cat geoip/category-ban-ru.list; } > _inputs/ban.src
          ip_opt _inputs/ban.src geoip/ban

      - name: Build geoip/router (dedup + optimize)
        run: |
          set -Eeuo pipefail
          source .ci/helpers.sh
          tmp="$(mktemp)"

          {
            for f in geoip/discord-voice geoip/refilter-community; do
              [[ -f "$f" || -f "$f.list" ]] || continue
              cat "$f" 2>/dev/null || true
              cat "$f.list" 2>/dev/null || true
              echo
            done
          } > "$tmp"

          ip_opt "$tmp" geoip/router
          rm -f "$tmp" "$tmp.list"

      - name: Commit ONLY geosite/ and geoip/ to sources branch
        run: |
          set -Eeuo pipefail

          git config --local user.email "${COMMIT_USER_EMAIL}"
          git config --local user.name  "${COMMIT_USER_NAME}"

          git rm -r --cached --ignore-unmatch . >/dev/null 2>&1 || true
          git add -f geosite geoip

          git diff --staged --quiet && exit 0
          git commit -m "Update sources (geosite + geoip only) $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push || true
