name: Generate xray (geosite + geoip) from sources

on:
  schedule:
    - cron: "10 0 * * *"
  workflow_dispatch:

concurrency:
  group: xray-from-sources-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  GOFLAGS: -buildvcs=false

  COMMIT_USER_NAME: github-actions[bot]
  COMMIT_USER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com

  GEOSITE_INCLUDE: |
    private
    category-ru
    ru-bundle
    category-ban-ru
    youtube

  GEOIP_INCLUDE: |
    ru
    ru-bundle
    private
    category-ban-ru

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Switch to branch xray-rulesets (create if missing)
        run: |
          set -Eeuo pipefail
          BR="xray-rulesets"

          git config --local user.name  "${COMMIT_USER_NAME}"
          git config --local user.email "${COMMIT_USER_EMAIL}"

          if git fetch --no-tags --depth=1 origin "refs/heads/${BR}:refs/remotes/origin/${BR}" >/dev/null 2>&1; then
            git switch -C "${BR}" "refs/remotes/origin/${BR}"
          else
            git switch --orphan "${BR}"
            git rm -r --ignore-unmatch . >/dev/null 2>&1 || true
            git commit --allow-empty -m "Initialize xray-rulesets"
            git push -u origin "HEAD:${BR}"
          fi

      - name: Fetch sources + main
        run: |
          set -Eeuo pipefail
          git fetch --no-tags --depth=1 origin sources
          git fetch --no-tags --depth=1 origin main

      - name: Prepare work dirs
        run: |
          set -Eeuo pipefail
          rm -rf /tmp/src /tmp/community /tmp/geoip /tmp/out /tmp/dlc /tmp/v2geoip
          mkdir -p /tmp/src /tmp/community/data /tmp/geoip /tmp/out

      - name: Extract geosite/geoip from sources (fast via git archive)
        run: |
          set -Eeuo pipefail
          git archive --format=tar origin/sources geosite | tar -x -C /tmp/src
          git archive --format=tar origin/sources geoip   | tar -x -C /tmp/src

          cp -a /tmp/src/geosite/. /tmp/community/data/
          cp -a /tmp/src/geoip/.   /tmp/geoip/

      - name: Filter lists by GEOSITE_INCLUDE / GEOIP_INCLUDE (no content changes)
        run: |
          set -Eeuo pipefail

          keep_filter_dir() {
            local dir="$1"
            local inc="$2"

            declare -A keep=()
            while IFS= read -r raw; do
              raw="${raw//$'\r'/}"
              raw="${raw%%#*}"
              item="$(echo "$raw" | xargs)"
              [[ -n "$item" ]] || continue

              keep["$item"]=1
              [[ "$item" == *.list ]] || keep["$item.list"]=1

              bn="${item##*/}"
              keep["$bn"]=1
              [[ "$bn" == *.list ]] || keep["$bn.list"]=1

              base="${bn%.list}"
              keep["$base"]=1
              keep["$base.list"]=1
            done <<< "$inc"

            find "$dir" -type f -print0 | while IFS= read -r -d '' f; do
              rel="${f#${dir}/}"
              bn="${rel##*/}"
              base="${bn%.list}"
              if [[ -n "${keep[$rel]:-}${keep[$bn]:-}${keep[$base]:-}${keep[$base.list]:-}" ]]; then
                continue
              fi
              rm -f "$f"
            done

            find "$dir" -type d -empty -delete || true
          }

          keep_filter_dir "/tmp/community/data" "${GEOSITE_INCLUDE}"
          keep_filter_dir "/tmp/geoip"          "${GEOIP_INCLUDE}"

      - name: Make v2fly-style filenames for geosite (drop only .list; content unchanged)
        run: |
          set -Eeuo pipefail
          find /tmp/community/data -type f -name '*.list' -print0 | while IFS= read -r -d '' f; do
            dir="$(dirname "$f")"
            base="$(basename "$f" .list)"
            mv -f "$f" "$dir/$base"
          done

      - name: Compute build hashes (tree hash + includes + builder + workflow)
        run: |
          set -Eeuo pipefail
          EMPTY_TREE="4b825dc642cb6eb9a060e54bf8d69288fbee4904"

          GEOSITE_TREE="$(git rev-parse "origin/sources^{tree}:geosite" 2>/dev/null || true)"
          GEOIP_TREE="$(git rev-parse "origin/sources^{tree}:geoip" 2>/dev/null || true)"
          [[ -n "${GEOSITE_TREE:-}" ]] || GEOSITE_TREE="${EMPTY_TREE}"
          [[ -n "${GEOIP_TREE:-}" ]] || GEOIP_TREE="${EMPTY_TREE}"

          GEOSITE_INC_SHA="$(printf '%s' "${GEOSITE_INCLUDE}" | sha256sum | awk '{print $1}')"
          GEOIP_INC_SHA="$(printf '%s' "${GEOIP_INCLUDE}" | sha256sum | awk '{print $1}')"

          WORKFLOW_SHA="$(
            git show "origin/main:.github/workflows/xray.yml" 2>/dev/null \
              | sha256sum | awk '{print $1}' \
              || printf '' | sha256sum | awk '{print $1}'
          )"

          echo "GEOSITE_TREE=${GEOSITE_TREE}" >> "${GITHUB_ENV}"
          echo "GEOIP_TREE=${GEOIP_TREE}"     >> "${GITHUB_ENV}"
          echo "GEOSITE_INC_SHA=${GEOSITE_INC_SHA}" >> "${GITHUB_ENV}"
          echo "GEOIP_INC_SHA=${GEOIP_INC_SHA}"     >> "${GITHUB_ENV}"
          echo "WORKFLOW_SHA=${WORKFLOW_SHA}"       >> "${GITHUB_ENV}"

      - name: Checkout v2fly/domain-list-community (builder)
        if: always()
        uses: actions/checkout@v6
        with:
          repository: v2fly/domain-list-community
          path: dlc
          fetch-depth: 1

      - name: Checkout v2fly/geoip (builder)
        if: always()
        uses: actions/checkout@v6
        with:
          repository: v2fly/geoip
          path: v2geoip
          fetch-depth: 1

      - name: Decide geosite build
        run: |
          set -Eeuo pipefail
          BUILDER_SHA="$(git -C dlc rev-parse HEAD || echo none)"
          echo "DLC_SHA=${BUILDER_SHA}" >> "${GITHUB_ENV}"

          GEOSITE_BUILD_HASH="$(
            printf '%s\n%s\n%s\n%s\n' \
              "${GEOSITE_TREE}" \
              "${GEOSITE_INC_SHA}" \
              "${BUILDER_SHA}" \
              "${WORKFLOW_SHA}" \
            | sha256sum | awk '{print $1}'
          )"
          echo "GEOSITE_BUILD_HASH=${GEOSITE_BUILD_HASH}" >> "${GITHUB_ENV}"

          PREV="$(cat geosite.hash 2>/dev/null || true)"
          if [[ "${GEOSITE_BUILD_HASH}" != "${PREV}" ]]; then
            echo "GEOSITE_NEEDS_BUILD=1" >> "${GITHUB_ENV}"
          else
            echo "GEOSITE_NEEDS_BUILD=0" >> "${GITHUB_ENV}"
          fi

      - name: Decide geoip build
        run: |
          set -Eeuo pipefail
          BUILDER_SHA="$(git -C v2geoip rev-parse HEAD || echo none)"
          echo "V2GEOIP_SHA=${BUILDER_SHA}" >> "${GITHUB_ENV}"

          GEOIP_BUILD_HASH="$(
            printf '%s\n%s\n%s\n%s\n' \
              "${GEOIP_TREE}" \
              "${GEOIP_INC_SHA}" \
              "${BUILDER_SHA}" \
              "${WORKFLOW_SHA}" \
            | sha256sum | awk '{print $1}'
          )"
          echo "GEOIP_BUILD_HASH=${GEOIP_BUILD_HASH}" >> "${GITHUB_ENV}"

          PREV="$(cat geoip.hash 2>/dev/null || true)"
          if [[ "${GEOIP_BUILD_HASH}" != "${PREV}" ]]; then
            echo "GEOIP_NEEDS_BUILD=1" >> "${GITHUB_ENV}"
          else
            echo "GEOIP_NEEDS_BUILD=0" >> "${GITHUB_ENV}"
          fi

      - name: Setup Go (only if any build needed)
        if: env.GEOSITE_NEEDS_BUILD == '1' || env.GEOIP_NEEDS_BUILD == '1'
        uses: actions/setup-go@v6
        with:
          go-version-file: dlc/go.mod
          cache: true
          cache-dependency-path: |
            dlc/go.sum
            v2geoip/go.sum

      - name: Build geosite.dat via v2fly/domain-list-community
        if: env.GEOSITE_NEEDS_BUILD == '1'
        run: |
          set -Eeuo pipefail
          rm -rf dlc/data
          mkdir -p dlc/data
          cp -a /tmp/community/data/. dlc/data/

          pushd dlc >/dev/null
          go run ./ -outputdir=/tmp/out
          popd >/dev/null

          test -s /tmp/out/dlc.dat
          mv -f /tmp/out/dlc.dat ./geosite.dat
          printf '%s' "${GEOSITE_BUILD_HASH}" > ./geosite.hash

      - name: Build geoip.dat via v2fly/geoip (config generated by jq)
        if: env.GEOIP_NEEDS_BUILD == '1'
        run: |
          set -Eeuo pipefail
          pushd v2geoip >/dev/null
          go mod download
          go build -o geoip
          popd >/dev/null

          inputs_jsonl="/tmp/geoip.inputs.jsonl"
          : > "${inputs_jsonl}"

          while IFS= read -r raw; do
            raw="${raw//$'\r'/}"
            raw="${raw%%#*}"
            name="$(echo "$raw" | xargs)"
            [[ -n "$name" ]] || continue

            base="${name##*/}"
            base="${base%.list}"

            src=""
            if [[ -f "/tmp/geoip/${base}.list" ]]; then
              src="/tmp/geoip/${base}.list"
            elif [[ -f "/tmp/geoip/${base}" ]]; then
              src="/tmp/geoip/${base}"
            else
              continue
            fi

            if [[ "${base}" == "private" ]]; then
              jq -nc --arg n "${base}" --arg u "${src}" \
                '{type:"text",action:"add",args:{name:$n,uri:$u}}' >> "${inputs_jsonl}"
            else
              jq -nc --arg n "${base}" --arg u "${src}" \
                '{type:"text",action:"add",args:{name:$n,uri:$u,onlyIPType:"ipv4"}}' >> "${inputs_jsonl}"
            fi
          done <<< "${GEOIP_INCLUDE}"

          jq -s '{
            input: .,
            output: [
              {
                type: "v2rayGeoIPDat",
                action: "output",
                args: { outputDir: "/tmp/out", outputName: "geoip.dat" }
              }
            ]
          }' "${inputs_jsonl}" > /tmp/geoip.config.json

          rm -f "${inputs_jsonl}"

          ./v2geoip/geoip -c /tmp/geoip.config.json
          test -s /tmp/out/geoip.dat
          mv -f /tmp/out/geoip.dat ./geoip.dat
          printf '%s' "${GEOIP_BUILD_HASH}" > ./geoip.hash

      - name: Commit updated files
        run: |
          set -Eeuo pipefail
          git config --local user.email "${COMMIT_USER_EMAIL}"
          git config --local user.name  "${COMMIT_USER_NAME}"

          git add -A geosite.dat geosite.hash geoip.dat geoip.hash
          git diff --staged --quiet && exit 0
          git commit -m "Update xray geofiles $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push

      - name: Purge jsDelivr CDN
        if: env.GEOSITE_NEEDS_BUILD == '1' || env.GEOIP_NEEDS_BUILD == '1'
        run: |
          set -Eeuo pipefail
          for f in geosite.dat geosite.hash geoip.dat geoip.hash; do
            [[ -f "$f" ]] || continue
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@xray-rulesets/${f}"
          done
