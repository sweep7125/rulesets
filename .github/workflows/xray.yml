name: Generate xray (geosite + geoip) from sources

on:
  schedule:
    - cron: "10 0 * * *"
  workflow_dispatch:

concurrency:
  group: xray-from-sources
  cancel-in-progress: true

permissions:
  contents: write

env:
  COMMIT_USER_NAME: ${{ github.actor }}
  COMMIT_USER_EMAIL: ${{ github.actor }}@users.noreply.github.com
  GOFLAGS: -buildvcs=false
  DEBIAN_FRONTEND: noninteractive
  GEOSITE_INCLUDE: |
    private
    category-ru
    reddit
    spotify
    youtube
    discord
    telegram
    refilter-domains
    refilter-community-domains
    category-ban-ru
    category-nongov-ru
    torrent-trackers
    torrent-trackers-custom
    antifilter-community-domains
    google-ai
    russia-outside
    category-gov-ru
    russia-inside
  GEOIP_INCLUDE: |
    ru
    private
    category-ban-ru
    cloudflare-all
    cloudflare-ipv4
    cloudflare-ipv6
    discord-voice-ips
    telegram
    refilter-ips
    refilter-community-ips

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Switch to branch xray-rulesets (create if missing)
        run: |
          set -Eeuo pipefail
          if git ls-remote --exit-code --heads origin refs/heads/xray-rulesets >/dev/null 2>&1; then
            git fetch --no-tags --depth=1 origin refs/heads/xray-rulesets:refs/remotes/origin/xray-rulesets
            git switch -c xray-rulesets --track origin/xray-rulesets || git switch xray-rulesets
            git pull --ff-only || true
          else
            git switch -c xray-rulesets
            git -c user.email="${{ env.COMMIT_USER_EMAIL }}" -c user.name="${{ env.COMMIT_USER_NAME }}" \
              commit --allow-empty -m "Initialize xray-rulesets"
            git push -u origin HEAD:xray-rulesets
          fi

      - name: Prepare helpers and files from main (use /tmp)
        run: |
          set -Eeuo pipefail
          mkdir -p /tmp/community/data /tmp/geoip /tmp/out
          git fetch --no-tags --depth=1 origin main
          git show origin/main:.ci/optimize.py > /tmp/optimize.py
          git show origin/main:config.json   > /tmp/config.json   || true
          cat > /tmp/helpers.sh <<'SH'
          set -Eeuo pipefail
          OPT_PY="/tmp/optimize.py"
          dom_xray_preserve() { python3 "$OPT_PY" domains "$1" "$2" --input-type xray --target preserve --view xray; }
          SH
          chmod +x /tmp/optimize.py

      - name: Pull geosite & geoip from sources (filter by $GEOSITE_INCLUDE)
        run: |
          set -Eeuo pipefail
          git fetch --no-tags --depth=1 origin sources
      
          # Сформируем множество для фильтрации geosite из переменной окружения
          declare -A keep=()
          if [[ -n "${GEOSITE_INCLUDE:-}" ]]; then
            # Поддерживаем имена с/без .list, с путём и без него (basename)
            while IFS= read -r raw; do
              raw="${raw//$'\r'/}"; raw="${raw%%#*}"
              item="$(echo "$raw" | xargs)"
              [[ -z "$item" ]] && continue
              keep["$item"]=1
              [[ "$item" == *.list ]] || keep["$item.list"]=1
              bn="${item##*/}"
              keep["$bn"]=1
              [[ "$bn" == *.list ]] || keep["$bn.list"]=1
              if [[ "$bn" == *.list ]]; then
                base="${bn%.list}"
                keep["$base"]=1
              fi
            done <<< "${GEOSITE_INCLUDE}"
          fi
      
          # geosite → /tmp/community/data (только выбранные файлы, если список задан)
          rm -rf /tmp/community/data && mkdir -p /tmp/community/data
          while IFS= read -r p; do
            rel="$p"                                # относительный путь внутри дерева geosite/
            bn="${rel##*/}"                         # basename
            base="${bn%.list}"
      
            if [[ ${#keep[@]} -gt 0 ]]; then
              if [[ -z "${keep[$rel]:-}" && -z "${keep[$bn]:-}" && -z "${keep[$base]:-}" && -z "${keep[$base.list]:-}" ]]; then
                continue
              fi
            fi
      
            mkdir -p "/tmp/community/data/$(dirname "$rel")"
            git show "origin/sources:geosite/$rel" > "/tmp/community/data/$rel"
          done < <(git ls-tree -r --name-only origin/sources:geosite || true)
      
          # geoip → /tmp/geoip (без фильтра по env; если нужно — по аналогии)
          rm -rf /tmp/geoip && mkdir -p /tmp/geoip
          while IFS= read -r p; do
            rel="$p"
            mkdir -p "/tmp/geoip/$(dirname "$rel")"
            git show "origin/sources:geoip/$rel" > "/tmp/geoip/$rel"
          done < <(git ls-tree -r --name-only origin/sources:geoip || true)

      - name: Normalize /tmp/community/data (xray preserve; idempotent)
        run: |
          set -Eeuo pipefail
          source /tmp/helpers.sh
          find /tmp/community/data -type f -print0 | while IFS= read -r -d '' f; do
            tmp="$(mktemp --suffix=.list)"
            dom_xray_preserve "$f" "$tmp"
            mv "$tmp" "$f"
          done

      - name: Make v2fly-style filenames (drop .list)
        run: |
          set -Eeuo pipefail
          find /tmp/community/data -type f -name '*.list' -print0 \
            | while IFS= read -r -d '' f; do
                dir="$(dirname "$f")"
                base="$(basename "$f" .list)"
                mv -f "$f" "$dir/$base"
              done

      - name: Checkout Loyalsoldier/domain-list-custom (builder only)
        uses: actions/checkout@v5
        with:
          repository: Loyalsoldier/domain-list-custom
          path: custom
          fetch-depth: 1
          filter: blob:none

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./custom/go.mod
          cache-dependency-path: ./custom/go.sum
          cache: true

      - name: Build geosite.dat (output to /tmp/out)
        run: |
          set -Eeuo pipefail
          pushd custom >/dev/null
          # exportlists выключен, берём нормализованные источники из /tmp/community/data
          go run ./ -outputpath=/tmp/out -exportlists= -datapath=/tmp/community/data -togfwlist=category-ru
          popd >/dev/null
          test -s /tmp/out/geosite.dat || { echo "geosite.dat not generated" >&2; exit 1; }

      - name: Build geoip.dat from /tmp/geoip via Loyalsoldier/geoip (output to /tmp/out)
        run: |
          set -Eeuo pipefail
          rm -rf /tmp/geoip-src
          git clone --depth=1 https://github.com/Loyalsoldier/geoip /tmp/geoip-src

          pushd /tmp/geoip-src >/dev/null
          go build ./
          popd >/dev/null

          python3 - <<'PY'
          import os, json, sys
          inc = os.environ.get("GEOIP_INCLUDE","").strip()
          if not inc:
              print("GEOIP_INCLUDE пуст: нечего собирать", file=sys.stderr); sys.exit(1)

          wanted = []
          for line in inc.splitlines():
              line = line.split('#',1)[0].strip()
              if not line: continue
              base = os.path.basename(line)
              if base.endswith(".list"): base = base[:-5]
              wanted.append(base)
          wanted = sorted(set(wanted))

          inputs, missing = [], []
          for name in wanted:
              p_noext = f"/tmp/geoip/{name}"
              p_list  = p_noext + ".list"
              if   os.path.isfile(p_list):
                  inputs.append({"type":"text","action":"add","args":{"name":name,"uri":p_list}})
              elif os.path.isfile(p_noext):
                  inputs.append({"type":"text","action":"add","args":{"name":name,"uri":p_noext}})
              else:
                  missing.append(name)

          if not inputs:
              print("ERROR: ни один из запрошенных geoip-листов не найден: " + ", ".join(missing), file=sys.stderr)
              sys.exit(1)
          if missing:
              print("WARN: отсутствуют списки: " + ", ".join(missing), file=sys.stderr)

          cfg = {
            "input": inputs,
            "output": [{
              "type": "v2rayGeoIPDat",
              "action": "output",
              "args": {"outputDir": "/tmp/out", "outputName": "geoip.dat"}
            }]
          }
          os.makedirs("/tmp/out", exist_ok=True)
          with open("/tmp/config.json","w") as f: json.dump(cfg, f, ensure_ascii=False, indent=2)
          PY

          echo "== using config.json ==" && cat /tmp/config.json

          pushd /tmp >/dev/null
          ./geoip-src/geoip convert -c /tmp/config.json
          popd >/dev/null
          
      - name: Publish ONLY *.dat to repo root
        run: |
          set -Eeuo pipefail
          # должны быть сгенерированы хотя бы один .dat
          if [[ ! -s /tmp/out/geosite.dat && ! -s /tmp/out/geoip.dat ]]; then
            echo "No .dat files built — aborting publish" >&2
            exit 1
          fi
          # подчистим корень ветки: оставим только .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          # перенесём .dat в корень
          [[ -s /tmp/out/geosite.dat ]] && mv /tmp/out/geosite.dat ./geosite.dat
          [[ -s /tmp/out/geoip.dat   ]] && mv /tmp/out/geoip.dat   ./geoip.dat
          ls -l *.dat || true

      - name: Commit only geosite.dat and geoip.dat
        run: |
          set -Eeuo pipefail
          git config --local user.email "${COMMIT_USER_EMAIL}"
          git config --local user.name  "${COMMIT_USER_NAME}"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          git commit -m "Update xray geofiles ${DATE}"
          git push || true
