name: Generate sing-box rulesets from sources

on:
  schedule:
    - cron: "7 0 * * *"
  workflow_dispatch:

concurrency:
  group: singbox-from-sources
  cancel-in-progress: true

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  SING_BOX_VERSION: "1.12.17"
  COMMIT_USER_NAME: "github-actions[bot]"
  COMMIT_USER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Switch to branch sing-box-rulesets (create if missing)
        run: |
          set -Eeuo pipefail
          BR="sing-box-rulesets"

          git config --local user.name  "${COMMIT_USER_NAME}"
          git config --local user.email "${COMMIT_USER_EMAIL}"

          if git fetch --no-tags --depth=1 origin "refs/heads/${BR}:refs/remotes/origin/${BR}" >/dev/null 2>&1; then
            git switch -C "${BR}" "refs/remotes/origin/${BR}"
          else
            git switch --orphan "${BR}"
            git rm -r --ignore-unmatch . >/dev/null 2>&1 || true
            git commit --allow-empty -m "Initialize sing-box rules branch"
            git push -u origin "HEAD:${BR}"
          fi

      - name: Compute build hash & decide build (git tree hash)
        run: |
          set -Eeuo pipefail

          EMPTY_TREE="4b825dc642cb6eb9a060e54bf8d69288fbee4904"

          git fetch --no-tags --depth=1 origin sources || true
          git fetch --no-tags --depth=1 origin main || true

          GEOSITE_TREE="$(git rev-parse "origin/sources^{tree}:geosite" 2>/dev/null || true)"
          GEOIP_TREE="$(git rev-parse "origin/sources^{tree}:geoip" 2>/dev/null || true)"
          [[ -n "${GEOSITE_TREE:-}" ]] || GEOSITE_TREE="${EMPTY_TREE}"
          [[ -n "${GEOIP_TREE:-}" ]] || GEOIP_TREE="${EMPTY_TREE}"

          # IMPORTANT: this file is sing-box.yml
          WORKFLOW_SHA="$(
            git show "origin/main:.github/workflows/sing-box.yml" 2>/dev/null \
              | sha256sum | awk '{print $1}' \
              || printf '' | sha256sum | awk '{print $1}'
          )"

          BUILD_HASH="$(
            printf '%s\n%s\n%s\n%s\n' \
              "${GEOSITE_TREE}" \
              "${GEOIP_TREE}" \
              "${SING_BOX_VERSION}" \
              "${WORKFLOW_SHA}" \
            | sha256sum | awk '{print $1}'
          )"

          echo "SRS_BUILD_HASH=${BUILD_HASH}" >> "${GITHUB_ENV}"

          PREV_HASH="$(cat srs.hash 2>/dev/null || true)"
          if [[ "${BUILD_HASH}" != "${PREV_HASH}" ]]; then
            echo "SRS_NEEDS_BUILD=1" >> "${GITHUB_ENV}"
          else
            echo "SRS_NEEDS_BUILD=0" >> "${GITHUB_ENV}"
          fi

      - name: Install sing-box (fixed version)
        if: env.SRS_NEEDS_BUILD == '1'
        run: |
          set -Eeuo pipefail
          curl -fsSL https://sing-box.app/install.sh | sudo -E sh -s -- --version "${SING_BOX_VERSION}"
          sing-box version

      - name: Build *.srs to repository root (streaming; jq; temp JSON only)
        if: env.SRS_NEEDS_BUILD == '1'
        run: |
          set -Eeuo pipefail

          git rm -r --ignore-unmatch . >/dev/null 2>&1 || true
          rm -f srs.hash

          mkdir -p /tmp/json

          geosite_to_json_stream() {
            awk '
              function trim(s){ sub(/^[ \t]+/,"",s); sub(/[ \t]+$/,"",s); return s }
              {
                gsub(/\r/,"")
                s=trim($0)
                if (s=="") next
                if (s ~ /^include:/) next

                if (s ~ /^full:/)   { v=substr(s,6); v=trim(v); if(v!="") print "domain\t"  v; next }
                if (s ~ /^domain:/) { v=substr(s,8); v=trim(v); sub(/^\./,"",v); if(v!="") print "suffix\t"  v; next }
                if (s ~ /^keyword:/){ v=substr(s,9); v=trim(v); if(v!="") print "keyword\t" v; next }
                if (s ~ /^regexp:/) { v=substr(s,8); v=trim(v); if(v!="") print "regex\t"   v; next }

                v=s
                sub(/^\+\./,"",v)
                sub(/^\./,"",v)
                v=trim(v)
                if(v!="") print "suffix\t" v
              }
            ' | jq -Rn '
              def add($k; $v): .rules[0][$k] = ((.rules[0][$k] // []) + [$v]);
              reduce (inputs | split("\t")) as $it ({"version":3,"rules":[{}]};
                if   $it[0]=="domain"  then add("domain";         $it[1])
                elif $it[0]=="suffix"  then add("domain_suffix";  $it[1])
                elif $it[0]=="keyword" then add("domain_keyword"; $it[1])
                elif $it[0]=="regex"   then add("domain_regex";   $it[1])
                else . end
              )
              | .rules[0] |= with_entries(select(.value | length > 0))
              | if (.rules[0] | length) == 0 then .rules = [] else . end
            '
          }

          # FIX: no ternary operator (?:) to support newer jq builds
          geoip_to_json_stream() {
            jq -Rn '
              [inputs | select(length > 0)] as $a
              | if ($a|length) > 0
                then {"version":3, "rules":[{"ip_cidr":$a}]}
                else {"version":3, "rules":[]}
                end
            '
          }

          geosite_list="$(git ls-tree -r --name-only origin/sources:geosite 2>/dev/null || true)"
          if [[ -n "${geosite_list}" ]]; then
            while IFS= read -r f; do
              [[ -n "${f}" ]] || continue
              base="${f%.list}"
              safe="${base//\//-}"
              tmp_json="/tmp/json/geosite-${safe}.json"

              git show "origin/sources:geosite/${f}" | geosite_to_json_stream > "${tmp_json}"
              sing-box rule-set compile --output "geosite-${safe}.srs" "${tmp_json}"
            done <<< "${geosite_list}"
          fi

          geoip_list="$(git ls-tree -r --name-only origin/sources:geoip 2>/dev/null || true)"
          if [[ -n "${geoip_list}" ]]; then
            while IFS= read -r f; do
              [[ -n "${f}" ]] || continue

              bn="$(basename "${f}")"
              base="${bn%.list}"
              safe="${f%.list}"
              safe="${safe//\//-}"
              tmp_json="/tmp/json/geoip-${safe}.json"

              if [[ "${base}" == "private" ]]; then
                git show "origin/sources:geoip/${f}" | geoip_to_json_stream > "${tmp_json}"
              else
                git show "origin/sources:geoip/${f}" | grep -v ':' | geoip_to_json_stream > "${tmp_json}"
              fi

              sing-box rule-set compile --output "geoip-${safe}.srs" "${tmp_json}"
            done <<< "${geoip_list}"
          fi

          rm -rf /tmp/json
          printf '%s' "${SRS_BUILD_HASH}" > srs.hash

          git add -A

      - name: Commit updates
        run: |
          set -Eeuo pipefail
          git config --local user.email "${COMMIT_USER_EMAIL}"
          git config --local user.name  "${COMMIT_USER_NAME}"

          git diff --staged --quiet && exit 0
          git commit -m "Update sing-box rulesets (*.srs) $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push || true

      - name: Purge jsDelivr CDN
        if: env.SRS_NEEDS_BUILD == '1'
        run: |
          set -Eeuo pipefail
          shopt -s nullglob
          for f in *.srs srs.hash; do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@sing-box-rulesets/${f}"
          done
          shopt -u nullglob
